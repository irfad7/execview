generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model ApiConfig {
  id           String    @id @default(cuid())
  service      String
  clientId     String?   @map("client_id")
  clientSecret String?   @map("client_secret")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  realmId      String?   @map("realm_id") // For QuickBooks
  expiresAt    Int?      @map("expires_at")
  isActive     Boolean   @default(false) @map("is_active")
  updatedAt    DateTime  @default(now()) @map("updated_at")
  
  userId       String    @map("user_id")
  
  @@unique([service, userId]) // Allow multiple users to connect to same service
}

model FieldMapping {
  id             String   @id @default(cuid())
  service        String
  category       String   // New: cases, calendar, leads, etc.
  mappings       String   @db.Text // JSON of field mappings
  updatedAt      DateTime @default(now()) @map("updated_at")
  
  userId         String   @map("user_id")

  @@unique([service, category, userId])
}

model DashboardCache {
  id        Int      @id @default(autoincrement())
  cacheKey  String   @map("cache_key") // New: allows multiple cache entries
  cacheData String   @map("cache_data") @db.Text
  updatedAt DateTime @default(now()) @map("updated_at")
  
  userId    String   @map("user_id")
  
  @@unique([userId, cacheKey])
}

model SyncStatus {
  id           Int      @id @default(autoincrement())
  service      String   // New: track sync per service
  lastUpdated  DateTime? @map("last_updated")
  status       String?
  errorMessage String?   @map("error_message")
  
  userId       String   @map("user_id")
  
  @@unique([userId, service])
}

model Log {
  id        Int      @id @default(autoincrement())
  service   String
  level     String
  message   String
  details   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  
  userId    String   @map("user_id")
}

model SystemSettings { // Fixed table name
  id        String   @id @default(cuid()) // Added proper ID
  settingKey String  @map("setting_key")
  settingValue String @map("setting_value") @db.Text
  updatedAt DateTime @default(now()) @map("updated_at")
  
  userId    String   @map("user_id")
  
  @@unique([settingKey, userId])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  sessions  Session[]
  profile   Profile?
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Profile {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id") // Link to User model
  name          String?
  firmName      String?  @map("firm_name")
  email         String?
  phone         String?
  practiceAreas String?  @map("practice_areas") @db.Text // JSON array
  timezone      String?
  businessHours String?  @map("business_hours") @db.Text // JSON object
  updatedAt     DateTime @default(now()) @map("updated_at")
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
