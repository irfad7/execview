generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model ApiConfig {
  id           String    @id @default(cuid())
  service      String
  clientId     String?   @map("client_id")
  clientSecret String?   @map("client_secret")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  realmId      String?   @map("realm_id") // For QuickBooks
  expiresAt    Int?      @map("expires_at")
  isActive     Boolean   @default(false) @map("is_active")
  updatedAt    DateTime  @default(now()) @map("updated_at")
  
  userId       String    @map("user_id")
  
  @@unique([service, userId]) // Allow multiple users to connect to same service
}

model FieldMapping {
  id             String   @id @default(cuid())
  service        String
  category       String   // New: cases, calendar, leads, etc.
  mappings       String   // JSON of field mappings
  updatedAt      DateTime @default(now()) @map("updated_at")
  
  userId         String   @map("user_id")

  @@unique([service, category, userId])
}

model DashboardCache {
  id        Int      @id @default(autoincrement())
  cacheKey  String   @map("cache_key") // New: allows multiple cache entries
  cacheData String   @map("cache_data")
  updatedAt DateTime @default(now()) @map("updated_at")
  
  userId    String   @map("user_id")
  
  @@unique([userId, cacheKey])
}

model SyncStatus {
  id           Int      @id @default(autoincrement())
  service      String   // New: track sync per service
  lastUpdated  DateTime? @map("last_updated")
  status       String?
  errorMessage String?   @map("error_message")
  
  userId       String   @map("user_id")
  
  @@unique([userId, service])
}

model Log {
  id        Int      @id @default(autoincrement())
  service   String
  level     String
  message   String
  details   String?
  createdAt DateTime @default(now()) @map("created_at")
  
  userId    String   @map("user_id")
}

model SystemSettings { // Fixed table name
  id        String   @id @default(cuid()) // Added proper ID
  settingKey String  @map("setting_key")
  settingValue String @map("setting_value")
  updatedAt DateTime @default(now()) @map("updated_at")
  
  userId    String   @map("user_id")
  
  @@unique([settingKey, userId])
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  sessions  Session[]
  profile   Profile?
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Profile {
  id            String   @id @default(cuid())
  userId        String   @unique @map("user_id") // Link to User model
  name          String?
  firmName      String?  @map("firm_name")
  email         String?
  phone         String?
  practiceAreas String?  @map("practice_areas") // JSON array
  timezone      String?
  businessHours String?  @map("business_hours") // JSON object
  updatedAt     DateTime @default(now()) @map("updated_at")
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// GHL-specific models for comprehensive integration
model GHLLocation {
  id          String   @id @default(cuid())
  locationId  String   @unique @map("location_id") // GHL location ID
  name        String
  companyName String?  @map("company_name")
  address     String?
  phone       String?
  email       String?
  website     String?
  timezone    String?
  settings    String?  // JSON object for location-specific settings
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  userId      String   @map("user_id")
  
  contacts    GHLContact[]
  opportunities GHLOpportunity[]
  pipelines   GHLPipeline[]
  
  @@unique([locationId, userId])
}

model GHLContact {
  id          String   @id @default(cuid())
  contactId   String   @unique @map("contact_id") // GHL contact ID
  firstName   String?  @map("first_name")
  lastName    String?  @map("last_name")
  email       String?
  phone       String?
  source      String?
  tags        String?  // JSON array
  customFields String? @map("custom_fields") // JSON object
  dateAdded   DateTime @map("date_added")
  lastActivity DateTime? @map("last_activity")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  locationId  String   @map("location_id")
  userId      String   @map("user_id")
  
  location    GHLLocation @relation(fields: [locationId], references: [locationId], onDelete: Cascade)
  opportunities GHLOpportunity[]
  
  @@unique([contactId, userId])
  @@index([locationId, dateAdded])
  @@index([source])
}

model GHLOpportunity {
  id              String   @id @default(cuid())
  opportunityId   String   @unique @map("opportunity_id") // GHL opportunity ID
  name            String
  status          String
  pipelineId      String   @map("pipeline_id")
  pipelineStageId String   @map("pipeline_stage_id")
  pipelineStageName String? @map("pipeline_stage_name")
  contactId       String   @map("contact_id")
  monetaryValue   Float?   @map("monetary_value")
  source          String?
  assignedTo      String?  @map("assigned_to")
  dateCreated     DateTime @map("date_created")
  lastStatusChange DateTime? @map("last_status_change")
  expectedCloseDate DateTime? @map("expected_close_date")
  notes           String?
  customFields    String?  @map("custom_fields") // JSON object
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  locationId      String   @map("location_id")
  userId          String   @map("user_id")
  
  location        GHLLocation @relation(fields: [locationId], references: [locationId], onDelete: Cascade)
  contact         GHLContact @relation(fields: [contactId], references: [contactId], onDelete: Cascade)
  
  @@unique([opportunityId, userId])
  @@index([locationId, status])
  @@index([pipelineId, pipelineStageId])
  @@index([dateCreated])
}

model GHLPipeline {
  id          String   @id @default(cuid())
  pipelineId  String   @unique @map("pipeline_id") // GHL pipeline ID
  name        String
  stages      String   // JSON array of pipeline stages
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  locationId  String   @map("location_id")
  userId      String   @map("user_id")
  
  location    GHLLocation @relation(fields: [locationId], references: [locationId], onDelete: Cascade)
  
  @@unique([pipelineId, userId])
}

model GHLWebhook {
  id          String   @id @default(cuid())
  eventType   String   @map("event_type")
  objectId    String   @map("object_id") // Contact/Opportunity ID
  locationId  String   @map("location_id")
  payload     String   // Full webhook payload as JSON
  processed   Boolean  @default(false)
  processedAt DateTime? @map("processed_at")
  errorMessage String? @map("error_message")
  createdAt   DateTime @default(now()) @map("created_at")
  
  userId      String   @map("user_id")
  
  @@index([processed, createdAt])
  @@index([eventType, locationId])
}
